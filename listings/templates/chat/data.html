{% extends "base.html" %}

{% block title %}Chat with {{ other_user.username }}{% endblock %}

{% block content %}
<div style="max-width: 900px; margin: 50px auto; padding: 20px;">
    <h1>Chat with {{ other_user.username }}</h1>

    <div id="chat-log" style="border: 1px solid #ddd; padding: 20px; height: 500px; overflow-y: scroll; margin: 20px 0; background: #f9f9f9; border-radius: 8px;">
        {% for message in messages %}
            <div style="margin: 15px 0; {% if message.sender == user %}text-align: right;{% endif %}">
                <div style="display: inline-block; max-width: 70%; padding: 12px 16px; border-radius: 12px; {% if message.sender == user %}background: #007bff; color: white;{% else %}background: #e0e0e0; color: #333;{% endif %}">
                    <strong>{{ message.sender.username }}:</strong> {{ message.message_text }}
                    <br>
                    <small style="font-size: 0.75em; opacity: 0.8;">{{ message.timestamp|date:"M d, Y H:i" }}</small>
                </div>
            </div>
        {% endfor %}
    </div>

    <div style="display: flex; gap: 10px;">
        <input id="chat-message-input" type="text" placeholder="Type your message..." style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px;">
        <button id="chat-message-submit" style="background: #007bff; color: white; padding: 12px 30px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">Send</button>
    </div>

    <a href="{% url 'listings:inbox' %}" style="display: inline-block; margin-top: 20px; padding: 10px 20px; background: #6c757d; color: white; text-decoration: none; border-radius: 5px;">Back to Inbox</a>
</div>

<script>
    const roomName = "{{ room_name }}";
    const currentUser = "{{ user.username }}";
    const otherUserId = {{ other_user.id }};
    
    const chatSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/chat/' + roomName + '/'
    );

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const chatLog = document.querySelector('#chat-log');
        
        const isCurrentUser = data.sender === currentUser;
        const alignment = isCurrentUser ? 'text-align: right;' : '';
        const bgColor = isCurrentUser ? 'background: #007bff; color: white;' : 'background: #e0e0e0; color: #333;';
        
        chatLog.innerHTML += `
            <div style="margin: 15px 0; ${alignment}">
                <div style="display: inline-block; max-width: 70%; padding: 12px 16px; border-radius: 12px; ${bgColor}">
                    <strong>${data.sender}:</strong> ${data.message}
                    <br>
                    <small style="font-size: 0.75em; opacity: 0.8;">Just now</small>
                </div>
            </div>
        `;
        chatLog.scrollTop = chatLog.scrollHeight;
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.querySelector('#chat-message-input').focus();
    document.querySelector('#chat-message-input').onkeyup = function(e) {
        if (e.keyCode === 13) { 
            document.querySelector('#chat-message-submit').click();
        }
    };

    document.querySelector('#chat-message-submit').onclick = function(e) {
        const messageInputDom = document.querySelector('#chat-message-input');
        const message = messageInputDom.value.trim();
        
        if (message) {
            chatSocket.send(JSON.stringify({
                'message': message,
                'receiver_id': otherUserId
            }));
            messageInputDom.value = '';
        }
    };

    const chatLog = document.querySelector('#chat-log');
    chatLog.scrollTop = chatLog.scrollHeight;
</script>
{% endblock %}